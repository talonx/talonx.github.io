---           
layout: post
title: gcc does not check out of scope names in unreachable code
date: 2011-01-30 08:42:42 UTC
updated: 2011-01-30 08:42:42 UTC
comments: false
categories: c gcc network programming
---
<div dir="ltr" style="text-align: left;" trbidi="on">While attempting to write a small HTTP server in C, I copied some code over from a previously written C file and immediately noticed a bug.<br /><br /><i>File httpd.c</i><br />#include "../mynet.h"<br /><br /><div style="font-family: &quot;Courier New&quot;,Courier,monospace;">if(errno = EINTR) {</div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp;&nbsp; //do something</div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;">} else {</div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp;&nbsp; err_sys("read error")</div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;">}</div><br /><br />Yes it's a stupid beginner mistake - typing the assignment operator instead of the equals check. The thread of execution would never enter the else block. I corrected it, but the interesting part came when I tried to compile it.<br /><br /><div style="font-family: &quot;Courier New&quot;,Courier,monospace;">cc ../mynet.c httpd.c</div><br /><br />mynet.c contains some handy helper functions that I've used in my other server classes. Guess what - the compilation failed with this message<br /><br /><br /><div style="font-family: &quot;Courier New&quot;,Courier,monospace;">"httpd.c:(.text+0x6a): undefined reference to `err_sys'"</div><br /><br />I checked my header and the err_sys function was nowhere to be seen. If this function is missing, how did my other class (from where I copied this code) compile previously?<br />After some fiddling around I put the assignment operator bug back, and guess what? The code compiled fine. <br /><br />Based on just these observations, we can conclude that the gcc C compiler ignored the unreachable (else) part of the code. It did not even check if the code inside the else block was legitimate. How far did this behaviour go? Let's see.<br /><br /><i>File httpd.c</i><br /><div style="font-family: &quot;Courier New&quot;,Courier,monospace;">#include "../mynet.h"</div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;">if(errno = EINTR) {</div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp;&nbsp; //do something</div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;">} else {</div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp;&nbsp; mocha(); //Undefined function</div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;">}</div><br /><br />This compiles fine.<br /><br /><i>File httpd.c</i><br /><div style="font-family: &quot;Courier New&quot;,Courier,monospace;">#include "../mynet.h"</div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;"><br /></div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;">if(errno = EINTR) {</div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp;&nbsp; //do something</div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;">} else {</div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;">&nbsp;&nbsp;&nbsp; asdf;</div><div style="font-family: &quot;Courier New&quot;,Courier,monospace;">}</div><br /><br />This correctly fails with an error.<br /><br />So syntax checks are being done in code that is known to be unreachable, but there are no checks for undefined functions. A bug? I would say yes. Google did not turn up much except this old link - <a href="http://compgroups.net/comp.lang.c++.moderated/could-if-else-avoid-syntax-checking-compile-time-unreachable-code" target="_blank">http://compgroups.net/comp.lang.c++.moderated/could-if-else-avoid-syntax-checking-compile-time-unreachable-code</a></div>