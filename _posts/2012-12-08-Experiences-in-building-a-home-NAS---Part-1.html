---           
layout: post
title: Experiences in building a home NAS - Part 1
date: 2012-12-08 16:09:57 UTC
updated: 2012-12-08 16:09:57 UTC
comments: false
categories: backup freenas hardware nas
---
Some months back I had this email conversation with a friend about the best strategy for storing movies/music/photos at home. I was running out of space, again. One of my external 1TB drives had crashed. <br /><br />Hard drives fail all the time. To backup the hard drive, you need another. Multiply that by the number of drives you have. The bigger the hard drive which crashed, the bigger the psychic shock. And so on. The buy-another-1TB-drive-strategy was not working.<br /><br />My friend had done some research on this topic, and he suggested building a NAS box out of commodity hardware. We exchanged mails back and forth and researched a lot for a month. There's a huge internet community doing the same thing so finding information was not a problem. An option which seemed attractive was  combining a small server from HP with my own storage and RAM. This was the <a href="http://h10010.www1.hp.com/wwpc/uk/en/sm/WF06a/15351-15351-4237916-4237917-4237917-4248009.html?dnr=1" target="_blank">HP ProLiant MicroServer N36L/N40L</a>.<br /><br /><b>The hardware</b><br /><br />I finally went with this to avoid having to choose the non-storage hardware myself, being no expert in it. The specs for the N36L model were decent enough -&nbsp; <br /><ul><li>AMD Athlon II Neo (dual core) 1.8 GHz</li><li>1 GB included RAM (max 8 GB)</li><li>Seagate 160 GB</li><li>Gigabit ethernet </li></ul>The RAM and HDD were of course, not enough. But the rest of it was. It came with 4 drive bays - to put my own hard disks in.<br /><br />There were other factors in choosing this<br /><ul><li>I did not want a hardware RAID controller - it ties you down to the RAID controller.</li><li>I did not care for more storage bays.</li><li>It has 7 USB ports, with one internal which can host a flash drive to boot from, thus saving the other drive bays for storage!</li><li>To top it all, it was good looking.</li></ul><br /><b>The software</b><br /><br />That's the hardware. What about the OS? NAS software? Like I said, my friend had already done some research, and I got the pointers from him. <a href="http://www.freenas.org/" target="_blank">FreeNAS</a> is a superb option if you're building your home NAS. It's based on FreeBSD and supports the ZFS file system. ZFS was conceived and implemented at the erstwhile Sun Microsystems. The virtues of this filesystem - I'll just point you to the <a href="http://en.wikipedia.org/wiki/ZFS#Features" target="_blank">documentation</a>. Resilvering (auto repair) and copy-on-write are two of them.<br /><br /><b>Software RAID</b><br /><br />ZFS supports various software RAID options, including <a href="http://en.wikipedia.org/wiki/Non-standard_RAID_levels#RAID-Z" target="_blank">RAID-Z</a>. RAID-Z1 (the first level) essentially gives you the ability to survive one hard disk crash if you have 3.<br /><br />With RAID-Z1, if you have 3 x 1 TB drives, you will use 2 x 1 TB for data and 1 x 1 TB for parity information. Even if one of the hard disks crashes, you can add a new one and you're fine. You use 1 TB to pay for recoverability. There are other configurations if you want more redundancy, like being able to recover if you lose more than one drive at the same time - which are more expensive as they need more disks.<br /><br /><b>Buying the hardware</b><br /><br />I bought the ProLiant from a local dealer after scouring the Hyderabad classified pages. The HDD (3 x 1TB) and 4 GB of RAM I bought online, from Flipkart. Here are two bits of learning if you're doing the same<br /><ul><li>Buy ECC RAM if you want surefire data integrity.</li><li>Buy more hard disk space than you need now - you won't regret it. It will cost a bit more, but it's better than the alternative. The alternative would be to recreate all your ZFS volumes on the new (bigger disks). With my configuration, I'll have to buy 3 x (whatever GB) to upgrade my setup. Of course, the third option is that you don't go this HP microserver way at all, and choose a bigger box (custom built or otherwise) which supports more drives.</li></ul>It's a NAS, so I needed a network switch, which I bought from eBay. <a href="http://www.tp-link.com/en/products/details/?model=TL-SG1008D" target="_blank">This</a> had good reviews, had 8 ports and supported Gigabit ethernet. Plus some CAT6 cables.<br /><br /><b>Putting it all together</b><br /><br />The HP came with 4 drive bays, with one small (160 GB) HDD, where I installed FreeNAS. The other three went for storage (and parity). The RAM worked without a hitch, but that was because I had ensured it was compatible (see these <a href="http://n40l.wikia.com/wiki/HP_MicroServer_N40L_Wiki" target="_blank">hardware compatibility</a> <a href="http://www.overclockers.com.au/wiki/HP_Microserver" target="_blank">lists</a>).<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-3NG-KfoxQcE/UMNdjwy12WI/AAAAAAAAAAQ/37EBe8jLYBk/s1600/installation.jpeg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="186" src="http://1.bp.blogspot.com/-3NG-KfoxQcE/UMNdjwy12WI/AAAAAAAAAAQ/37EBe8jLYBk/s320/installation.jpeg" width="320" /></a></div><br />(All those cables were to connect my desktop monitor, keyboard and DVD drive to the HP server).<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-ZdnYF2iIdIg/UMNd099n_mI/AAAAAAAAAAY/7KDjhG5E8To/s1600/innards.jpeg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="234" src="http://1.bp.blogspot.com/-ZdnYF2iIdIg/UMNd099n_mI/AAAAAAAAAAY/7KDjhG5E8To/s320/innards.jpeg" width="320" /></a></div><br /><br /><br />Internal view - the 4 drive bays in vertically placed in front.<br /><br /><br />The FreeNAS interface is easy to use, so setting up ZFS volumes was a breeze.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-jZMHYgcHfwM/UMNfkq0XRnI/AAAAAAAAAAg/yMc_QiqjL3Q/s1600/freenas.jpeg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="204" src="http://3.bp.blogspot.com/-jZMHYgcHfwM/UMNfkq0XRnI/AAAAAAAAAAg/yMc_QiqjL3Q/s320/freenas.jpeg" width="320" /></a></div><br /><br />It also comes with a Cacti-like interface which lets you view OS metrics. <br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-5PNwl1zK5-8/UMNfrrGByrI/AAAAAAAAAAo/wXcJoJnQgJg/s1600/reporting.jpeg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="320" src="http://4.bp.blogspot.com/-5PNwl1zK5-8/UMNfrrGByrI/AAAAAAAAAAo/wXcJoJnQgJg/s320/reporting.jpeg" width="278" /></a></div><br /><br /><br />To complete the setup, I connected the 8 port switch to my ISP's router, and plugged in my desktop and the HP to the switch. FreeNAS lets you create NFS shares for the data stored on the NAS which I can then access as a network mounted volume.<br /><br />There really are a lot of resources about setting up a home NAS in this configuration. Some of the ones that I found helpful are <br /><ul><li><a href="http://www.avforums.com/forums/networking-nas/1431514-hp-proliant-microserver-n36l-owners-thread.html" target="_blank">HP ProLiant MicroServer N36L owners' thread</a></li><li><a href="http://forums.overclockers.com.au/showthread.php?t=958208" target="_blank">Another owners' thread</a> </li><li><a href="http://www.tenniswood.co.uk/technology/windows/review-hp-microserver-for-windows-home-server/" target="_blank">A review of the machine</a></li><li><a href="http://n40l.wikia.com/wiki/HP_MicroServer_N40L_Wiki" target="_blank">N40L wiki</a> (it's not very different from the N36L that I have)</li><li><a href="http://www.overclockers.com.au/wiki/HP_Microserver" target="_blank">Another hardware compatibility list</a></li><li>RAID-Z? <a href="https://blogs.oracle.com/roch/entry/when_to_and_not_to" target="_blank">Here you go</a></li><li><a href="https://blogs.oracle.com/timc/entry/demonstrating_zfs_self_healing" target="_blank">ZFS self-healing</a></li></ul><br />This does not complete the NAS setup. Performance testing has to be done. And also, backups. I'll write about these in the next post.<br /><ul>&nbsp;</ul><br />